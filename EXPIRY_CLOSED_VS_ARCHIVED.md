# Expiry: CLOSED vs ARCHIVED çŠ¶æ€è¯´æ˜

## ğŸ“‹ çŠ¶æ€å®šä¹‰

### CLOSED çŠ¶æ€
- **è§¦å‘æ–¹å¼**: 
  - è‡ªåŠ¨ï¼šèŒä½è¿‡æœŸï¼ˆ`expires_at < NOW()`ï¼‰
  - æ‰‹åŠ¨ï¼šé›‡ä¸»ç‚¹å‡» "Close" æŒ‰é’®
- **å«ä¹‰**: èŒä½æ‹›è˜å·²ç»“æŸï¼Œä¸å†æ¥å—ç”³è¯·
- **å¯è§æ€§**: å€™é€‰äººä¸å¯è§ï¼Œé›‡ä¸»å¯è§
- **æ“ä½œ**: 
  - å¯ä»¥åˆ é™¤
  - å¯ä»¥å½’æ¡£ï¼ˆArchiveï¼‰

### ARCHIVED çŠ¶æ€
- **è§¦å‘æ–¹å¼**: 
  - æ‰‹åŠ¨ï¼šé›‡ä¸»ç‚¹å‡» "Archive" æŒ‰é’®ï¼ˆä»…å¯¹ PUBLISHED èŒä½ï¼‰
- **å«ä¹‰**: é›‡ä¸»ä¸»åŠ¨å°†èŒä½å½’æ¡£ä¿å­˜ï¼Œé•¿æœŸå­˜å‚¨
- **å¯è§æ€§**: å€™é€‰äººä¸å¯è§ï¼Œé›‡ä¸»å¯è§
- **æ“ä½œ**: 
  - å¯ä»¥åˆ é™¤
  - å¯ä»¥æ¢å¤ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

## ğŸ”„ çŠ¶æ€æµè½¬

### æ­£å¸¸æµç¨‹

```
DRAFT (è‰ç¨¿)
    â†“
   æ”¯ä»˜
    â†“
PUBLISHED (å·²å‘å¸ƒ) â† 30å¤©æœ‰æ•ˆæœŸå¼€å§‹
    â†“
   è¿‡æœŸ
    â†“
CLOSED (å·²å…³é—­) â† è‡ªåŠ¨ç”± Cron Job æ‰§è¡Œ
```

### æ‰‹åŠ¨å½’æ¡£æµç¨‹

```
PUBLISHED (å·²å‘å¸ƒ)
    â†“
  é›‡ä¸»ç‚¹å‡» Archive
    â†“
ARCHIVED (å·²å½’æ¡£) â† æ‰‹åŠ¨æ“ä½œï¼Œé•¿æœŸä¿å­˜
```

### é€€æ¬¾æµç¨‹

```
PUBLISHED (å·²å‘å¸ƒ)
    â†“
  Stripe é€€æ¬¾
    â†“
CLOSED (å·²å…³é—­) â† è‡ªåŠ¨å¤„ç†
```

## âš™ï¸ è‡ªåŠ¨å¤„ç†è§„åˆ™

### Cron Job è‡ªåŠ¨å…³é—­
- **æ—¶é—´**: æ¯å¤©å‡Œæ™¨ 0:00 UTC
- **æ¡ä»¶**: `expires_at < NOW()` AND `status = PUBLISHED`
- **æ“ä½œ**: æ›´æ–°çŠ¶æ€ä¸º `CLOSED`
- **æ—¥å¿—**: "Closed 5 expired job postings"

### Stripe Webhook é€€æ¬¾å¤„ç†
- **è§¦å‘**: æ”¶åˆ° `charge.refunded` äº‹ä»¶
- **æ“ä½œ**: æ›´æ–°çŠ¶æ€ä¸º `CLOSED`
- **åŸå› **: é€€æ¬¾åèŒä½ä¸åº”ç»§ç»­æ˜¾ç¤º

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### ä½¿ç”¨ CLOSED çš„åœºæ™¯

1. **èŒä½è¿‡æœŸ**
   - 30 å¤©æœ‰æ•ˆæœŸåˆ°æœŸ
   - è‡ªåŠ¨ç”±ç³»ç»Ÿå…³é—­
   - ä¸å†æ˜¾ç¤ºç»™å€™é€‰äºº

2. **æ‹›è˜å®Œæˆ**
   - é›‡ä¸»æ‰¾åˆ°åˆé€‚å€™é€‰äºº
   - æ‰‹åŠ¨ç‚¹å‡» "Close" æŒ‰é’®
   - æå‰ç»“æŸæ‹›è˜

3. **æ”¯ä»˜é€€æ¬¾**
   - é›‡ä¸»ç”³è¯·é€€æ¬¾
   - Stripe å¤„ç†é€€æ¬¾æˆåŠŸ
   - ç³»ç»Ÿè‡ªåŠ¨å…³é—­èŒä½

### ä½¿ç”¨ ARCHIVED çš„åœºæ™¯

1. **é•¿æœŸä¿å­˜**
   - é›‡ä¸»æƒ³ä¿å­˜èŒä½ä¿¡æ¯ä½œä¸ºæ¨¡æ¿
   - ç”¨äºæœªæ¥ç±»ä¼¼èŒä½å‘å¸ƒ
   - ä¸å½±å“å½“å‰åˆ—è¡¨

2. **å†å²è®°å½•**
   - æŸ¥çœ‹è¿‡å¾€æ‹›è˜è®°å½•
   - åˆ†ææ‹›è˜æ•ˆæœ
   - æ•°æ®ç»Ÿè®¡

3. **æ¸…ç†åˆ—è¡¨**
   - ä» Published åˆ—è¡¨ç§»é™¤
   - ä¸åˆ é™¤æ•°æ®
   - å¯ä»¥éšæ—¶æŸ¥çœ‹

## ğŸ“Š çŠ¶æ€å¯¹æ¯”

| ç‰¹æ€§ | CLOSED | ARCHIVED |
|------|--------|----------|
| è§¦å‘æ–¹å¼ | è‡ªåŠ¨ + æ‰‹åŠ¨ | ä»…æ‰‹åŠ¨ |
| è‡ªåŠ¨è§¦å‘ | âœ… è¿‡æœŸ/é€€æ¬¾ | âŒ |
| å€™é€‰äººå¯è§ | âŒ | âŒ |
| é›‡ä¸»å¯è§ | âœ… | âœ… |
| å¯ä»¥åˆ é™¤ | âœ… | âœ… |
| å¯ä»¥ç¼–è¾‘ | âœ… | âœ… |
| å¯ä»¥æ¢å¤ | âŒ | æœªæ¥æ”¯æŒ |
| æ ‡ç­¾é¡µ | Closed | Archived |

## ğŸ”§ æŠ€æœ¯å®ç°

### è‡ªåŠ¨å…³é—­è¿‡æœŸèŒä½

```typescript
// src/lib/jobPostingExpiry.ts
export async function archiveExpiredJobPostings(): Promise<number> {
  const result = await prisma.jobPosting.updateMany({
    where: {
      id: { in: expiredJobIds },
    },
    data: {
      status: JobStatus.CLOSED, // â† CLOSED, not ARCHIVED
    },
  });
  
  console.log(`Closed ${result.count} expired job postings`);
  return result.count;
}
```

### Cron Job API

```typescript
// src/app/api/cron/archive-expired-jobs/route.ts
const closedCount = await archiveExpiredJobPostings();

return NextResponse.json({
  success: true,
  closedCount,  // â† closedCount, not archivedCount
  expiredJobIds,
  timestamp: new Date().toISOString(),
});
```

### Stripe Webhook é€€æ¬¾å¤„ç†

```typescript
// src/app/api/stripe/webhook/route.ts
async function handleChargeRefunded(charge: Stripe.Charge) {
  await prisma.jobPosting.update({
    where: { id: purchase.jobPostingId },
    data: {
      status: JobStatus.CLOSED, // â† CLOSED, not ARCHIVED
    },
  });
}
```

## ğŸ¨ ç”¨æˆ·ç•Œé¢

### Closed æ ‡ç­¾é¡µ
```
[All] [Published] [Drafts] [Closed] [Archived]
                           ^^^^^^^ 
                           æ˜¾ç¤ºè¿‡æœŸå’Œæ‰‹åŠ¨å…³é—­çš„èŒä½
```

### Archived æ ‡ç­¾é¡µ
```
[All] [Published] [Drafts] [Closed] [Archived]
                                    ^^^^^^^^^
                                    æ˜¾ç¤ºæ‰‹åŠ¨å½’æ¡£çš„èŒä½
```

### Published èŒä½æ“ä½œ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Senior Software Engineer            â”‚
â”‚ [Published]                         â”‚
â”‚                                     â”‚
â”‚ [Edit] [Archive]                   â”‚ â† æ‰‹åŠ¨å½’æ¡£
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Closed èŒä½æ¥æº
```
1. è‡ªåŠ¨è¿‡æœŸ (expires_at < NOW())
   â””â”€ Cron Job æ¯å¤©æ‰§è¡Œ

2. æ‰‹åŠ¨å…³é—­
   â””â”€ é›‡ä¸»ç‚¹å‡» "Close" æŒ‰é’®

3. æ”¯ä»˜é€€æ¬¾
   â””â”€ Stripe Webhook å¤„ç†
```

## ğŸ“ æ•°æ®åº“æŸ¥è¯¢

### æŸ¥è¯¢è¿‡æœŸå¹¶è‡ªåŠ¨å…³é—­çš„èŒä½

```sql
-- è¿‡æœŸèŒä½ï¼ˆå°†è¢« Cron Job å…³é—­ï¼‰
SELECT * FROM job_postings jp
JOIN job_posting_purchases jpp ON jp.id = jpp.job_posting_id
WHERE jpp.expires_at < NOW()
  AND jp.status = 'PUBLISHED';
```

### æŸ¥è¯¢æ‰€æœ‰ CLOSED èŒä½

```sql
-- åŒ…æ‹¬è¿‡æœŸçš„ã€æ‰‹åŠ¨å…³é—­çš„ã€é€€æ¬¾çš„
SELECT 
  jp.*,
  jpp.expires_at,
  jpp.paid_at,
  CASE 
    WHEN jpp.expires_at < NOW() THEN 'Expired'
    WHEN jpp.refunded_at IS NOT NULL THEN 'Refunded'
    ELSE 'Manually Closed'
  END AS close_reason
FROM job_postings jp
LEFT JOIN job_posting_purchases jpp ON jp.id = jpp.job_posting_id
WHERE jp.status = 'CLOSED';
```

### æŸ¥è¯¢ ARCHIVED èŒä½

```sql
-- ä»…æ‰‹åŠ¨å½’æ¡£çš„èŒä½
SELECT * FROM job_postings
WHERE status = 'ARCHIVED';
```

## âœ… å†³ç­–ç†ç”±

### ä¸ºä»€ä¹ˆè¿‡æœŸèŒä½å˜ä¸º CLOSEDï¼Ÿ

1. **è¯­ä¹‰æ¸…æ™°**
   - CLOSED = æ‹›è˜ç»“æŸï¼Œä¸å†æ¥å—ç”³è¯·
   - ARCHIVED = é•¿æœŸä¿å­˜ï¼Œå†å²è®°å½•
   - è¿‡æœŸæ˜¯æ‹›è˜ç»“æŸçš„ä¸€ç§æ–¹å¼

2. **ç”¨æˆ·ä½“éªŒ**
   - é›‡ä¸»å¯ä»¥åœ¨ Closed æ ‡ç­¾æ‰¾åˆ°è¿‡æœŸèŒä½
   - æ˜ç¡®åŒºåˆ†"è‡ªåŠ¨å…³é—­"å’Œ"æ‰‹åŠ¨å½’æ¡£"
   - ç¬¦åˆç”¨æˆ·å¿ƒæ™ºæ¨¡å‹

3. **æ“ä½œçµæ´»æ€§**
   - Closed èŒä½å¯ä»¥ï¼š
     - åˆ é™¤ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
     - å½’æ¡£ï¼ˆå¦‚æœæƒ³é•¿æœŸä¿å­˜ï¼‰
   - Archived èŒä½æ˜¯æœ€ç»ˆçŠ¶æ€

4. **æ•°æ®ç®¡ç†**
   - ä¸‰ä¸ªç‹¬ç«‹çš„åˆ—è¡¨ï¼šPublished, Closed, Archived
   - æ¸…æ™°çš„çŠ¶æ€æµè½¬
   - ä¾¿äºç»Ÿè®¡å’Œåˆ†æ

## ğŸ”„ çŠ¶æ€è½¬æ¢çŸ©é˜µ

| ä» \ åˆ° | DRAFT | PUBLISHED | CLOSED | ARCHIVED |
|---------|-------|-----------|--------|----------|
| **DRAFT** | - | âœ… æ”¯ä»˜ | âŒ | âŒ |
| **PUBLISHED** | âŒ | - | âœ… è¿‡æœŸ/æ‰‹åŠ¨ | âœ… æ‰‹åŠ¨ |
| **CLOSED** | âŒ | âŒ | - | âœ… æ‰‹åŠ¨ |
| **ARCHIVED** | âŒ | âŒ | âŒ | - |

## ğŸ¯ æœ€ä½³å®è·µ

### å¯¹äºé›‡ä¸»

1. **å®šæœŸæ£€æŸ¥ Closed æ ‡ç­¾**
   - æŸ¥çœ‹è¿‡æœŸçš„èŒä½
   - å†³å®šæ˜¯å¦åˆ é™¤æˆ–å½’æ¡£

2. **ä½¿ç”¨ Archive ä¿å­˜é‡è¦èŒä½**
   - ä½œä¸ºæ¨¡æ¿ä½¿ç”¨
   - å†å²è®°å½•ä¿å­˜
   - æ•°æ®åˆ†æç”¨é€”

3. **åŠæ—¶å¤„ç†æ‹›è˜å®Œæˆçš„èŒä½**
   - æ‰¾åˆ°å€™é€‰äººåæ‰‹åŠ¨ Close
   - é¿å…æµªè´¹æœ‰æ•ˆæœŸ

### å¯¹äºç³»ç»Ÿç®¡ç†å‘˜

1. **ç›‘æ§ Cron Job**
   - æ¯å¤©æ£€æŸ¥å…³é—­æ•°é‡
   - ç¡®ä¿æ­£å¸¸è¿è¡Œ

2. **æ•°æ®æ¸…ç†**
   - å®šæœŸæ¸…ç†é•¿æ—¶é—´ Closed çš„èŒä½
   - ä¿æŒæ•°æ®åº“æ•´æ´

3. **ç”¨æˆ·æ•™è‚²**
   - è§£é‡Š Closed vs Archived çš„åŒºåˆ«
   - æŒ‡å¯¼å¦‚ä½•ä½¿ç”¨å½’æ¡£åŠŸèƒ½

## ğŸš€ æœªæ¥å¢å¼º

1. **è‡ªåŠ¨å½’æ¡£**
   - Closed èŒä½ 90 å¤©åè‡ªåŠ¨å½’æ¡£
   - å¯é…ç½®çš„å½’æ¡£ç­–ç•¥

2. **æ¢å¤åŠŸèƒ½**
   - ä» Archived æ¢å¤åˆ° Draft
   - å¿«é€Ÿé‡æ–°å‘å¸ƒ

3. **æ‰¹é‡æ“ä½œ**
   - æ‰¹é‡å…³é—­èŒä½
   - æ‰¹é‡å½’æ¡£èŒä½

4. **æ™ºèƒ½æé†’**
   - èŒä½å³å°†è¿‡æœŸæé†’
   - å»ºè®®å½’æ¡£æé†’

## ğŸ“Š æ€»ç»“

**æ ¸å¿ƒåŸåˆ™ï¼š**
- âœ… **CLOSED** = æ‹›è˜å·²ç»“æŸï¼ˆè‡ªåŠ¨ + æ‰‹åŠ¨ï¼‰
- âœ… **ARCHIVED** = é•¿æœŸä¿å­˜ï¼ˆä»…æ‰‹åŠ¨ï¼‰
- âœ… è¿‡æœŸèŒä½ â†’ CLOSEDï¼ˆä¸æ˜¯ ARCHIVEDï¼‰
- âœ… é€€æ¬¾èŒä½ â†’ CLOSEDï¼ˆä¸æ˜¯ ARCHIVEDï¼‰
- âœ… é›‡ä¸»æ‰‹åŠ¨å½’æ¡£ â†’ ARCHIVED

è¿™æ ·è®¾è®¡ä½¿çŠ¶æ€æµè½¬æ›´æ¸…æ™°ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½ï¼
