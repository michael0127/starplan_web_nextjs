generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                     String              @id @default(uuid()) @db.Uuid
  email                  String              @unique
  name                   String?
  userType               UserType            @default(CANDIDATE) @map("user_type")
  createdAt              DateTime            @default(now()) @map("created_at")
  updatedAt              DateTime            @updatedAt @map("updated_at")
  hasCompletedOnboarding Boolean             @default(false) @map("has_completed_onboarding")
  jobTypes               String[]            @default([]) @map("job_types")
  preferredLocation      String?             @map("preferred_location")
  remoteOpen             Boolean             @default(false) @map("remote_open")
  avatarUrl              String?             @map("avatar_url")
  profile                Json?               @map("profile")
  categories             String[]            @default([])
  categorySkills         String[]            @default([]) @map("category_skills")
  currency               String?             @default("aud")
  experienceLevel        String?             @map("experience_level")
  experienceYearsFrom    Int?                @map("experience_years_from")
  experienceYearsTo      String?             @map("experience_years_to")
  payType                String?             @map("pay_type")
  salaryExpectationFrom  String?             @map("salary_expectation_from")
  salaryExpectationTo    String?             @map("salary_expectation_to")
  workAuthByCountry      Json?               @map("work_auth_by_country")
  workAuthCountries      String[]            @default([]) @map("work_auth_countries")
  workTypes              String[]            @default([]) @map("work_types")
  lastMatchedAt          DateTime?           @map("last_matched_at")
  candidateMatches       CandidateJobMatch[] @relation("CandidateMatches")
  cvs                    CV[]
  jobPostings            JobPosting[]

  @@map("users")
}

model CV {
  id            String              @id @default(uuid()) @db.Uuid
  fileUrl       String              @map("file_url")
  extractedData Json?               @map("extracted_data")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")
  userId        String              @map("user_id") @db.Uuid
  matches       CandidateJobMatch[]
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cvs")
}

model JobPosting {
  id                         String                    @id @default(uuid()) @db.Uuid
  userId                     String                    @map("user_id") @db.Uuid
  status                     JobStatus                 @default(DRAFT)
  createdAt                  DateTime                  @default(now()) @map("created_at")
  updatedAt                  DateTime                  @updatedAt @map("updated_at")
  jobTitle                   String                    @map("job_title")
  categorySkills             String[]                  @default([]) @map("category_skills")
  isCategoryManuallySelected Boolean                   @default(false) @map("is_category_manually_selected")
  countryRegion              String                    @map("country_region")
  experienceLevel            String                    @map("experience_level")
  experienceYearsFrom        Int                       @map("experience_years_from")
  experienceYearsTo          String                    @map("experience_years_to")
  workType                   String                    @map("work_type")
  payType                    String                    @map("pay_type")
  currency                   String
  payFrom                    String                    @map("pay_from")
  payTo                      String                    @map("pay_to")
  showSalaryOnAd             Boolean                   @default(true) @map("show_salary_on_ad")
  salaryDisplayText          String?                   @map("salary_display_text")
  companyName                String                    @default("") @map("company_name")
  jobDescription             String                    @default("") @map("job_description")
  jobSummary                 String                    @default("") @map("job_summary")
  keySellingPoint1           String?                   @map("key_selling_point_1")
  keySellingPoint2           String?                   @map("key_selling_point_2")
  keySellingPoint3           String?                   @map("key_selling_point_3")
  companyLogo                String?                   @map("company_logo")
  companyCoverImage          String?                   @map("company_cover_image")
  videoLink                  String?                   @map("video_link")
  selectedCountries          String[]                  @default([]) @map("selected_countries")
  workAuthByCountry          Json?                     @map("work_auth_by_country")
  applicationDeadline        DateTime?                 @map("application_deadline")
  categories                 String[]                  @default([])
  lastMatchedAt              DateTime?                 @map("last_matched_at")
  jdExtractedData            Json?                     @map("jd_extracted_data")
  jdFileUrl                  String?                   @map("jd_file_url")
  candidateMatches           CandidateJobMatch[]
  customScreeningQuestions   CustomScreeningQuestion[]
  purchase                   JobPostingPurchase?
  user                       User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  systemScreeningAnswers     SystemScreeningAnswer[]
  candidateRanking           CandidateRanking?

  @@map("job_postings")
}

model SystemScreeningAnswer {
  id              String     @id @default(uuid()) @db.Uuid
  jobPostingId    String     @map("job_posting_id") @db.Uuid
  questionId      String     @map("question_id")
  requirement     String
  selectedAnswers String[]   @default([]) @map("selected_answers")
  createdAt       DateTime   @default(now()) @map("created_at")
  jobPosting      JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  @@map("system_screening_answers")
}

model CustomScreeningQuestion {
  id                   String     @id @default(uuid()) @db.Uuid
  jobPostingId         String     @map("job_posting_id") @db.Uuid
  questionText         String     @map("question_text")
  answerType           String     @map("answer_type")
  options              String[]   @default([])
  mustAnswer           Boolean    @default(false) @map("must_answer")
  idealAnswer          Json?      @map("ideal_answer")
  disqualifyIfNotIdeal Boolean    @default(false) @map("disqualify_if_not_ideal")
  createdAt            DateTime   @default(now()) @map("created_at")
  jobPosting           JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  @@map("custom_screening_questions")
}

model JobPostingPurchase {
  id                    String        @id @default(uuid()) @db.Uuid
  jobPostingId          String        @unique @map("job_posting_id") @db.Uuid
  userId                String        @map("user_id") @db.Uuid
  productType           ProductType   @map("product_type")
  stripeProductId       String        @map("stripe_product_id")
  stripePriceId         String        @map("stripe_price_id")
  paymentStatus         PaymentStatus @default(PENDING) @map("payment_status")
  stripeCustomerId      String?       @map("stripe_customer_id")
  stripePaymentIntentId String?       @map("stripe_payment_intent_id")
  stripeSessionId       String?       @map("stripe_session_id")
  amount                Int
  currency              String        @default("aud")
  paidAt                DateTime?     @map("paid_at")
  refundedAt            DateTime?     @map("refunded_at")
  canceledAt            DateTime?     @map("canceled_at")
  metadata              Json?
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")
  expiresAt             DateTime?     @map("expires_at")
  jobPosting            JobPosting    @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paymentStatus])
  @@index([stripePaymentIntentId])
  @@index([stripeCustomerId])
  @@index([expiresAt])
  @@map("job_posting_purchases")
}

model CandidateJobMatch {
  id                  String     @id @default(uuid()) @db.Uuid
  candidateId         String     @map("candidate_id") @db.Uuid
  jobPostingId        String     @map("job_posting_id") @db.Uuid
  cvId                String?    @map("cv_id") @db.Uuid
  passedHardGate      Boolean    @default(false) @map("passed_hard_gate")
  hardGateReasons     String[]   @default([]) @map("hard_gate_reasons")
  matchDetails        Json?      @map("match_details")
  isActive            Boolean    @default(true) @map("is_active")
  candidateViewed     Boolean    @default(false) @map("candidate_viewed")
  employerViewed      Boolean    @default(false) @map("employer_viewed")
  candidateInterested Boolean    @default(false) @map("candidate_interested")
  employerInterested  Boolean    @default(false) @map("employer_interested")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
  candidate           User       @relation("CandidateMatches", fields: [candidateId], references: [id], onDelete: Cascade)
  cv                  CV?        @relation(fields: [cvId], references: [id])
  jobPosting          JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  @@unique([candidateId, jobPostingId])
  @@index([candidateId])
  @@index([jobPostingId])
  @@index([passedHardGate])
  @@index([isActive])
  @@index([createdAt])
  @@map("candidate_job_matches")
}

// AI Ranking Results - stores cached ranking results for job postings
model CandidateRanking {
  id                  String     @id @default(uuid()) @db.Uuid
  jobPostingId        String     @unique @map("job_posting_id") @db.Uuid
  
  // Ranking results - JSON array of {candidateId, rank}
  rankedCandidates    Json       @map("ranked_candidates")
  
  // Hash of candidate IDs to detect changes (sorted candidate IDs joined)
  candidateHash       String     @map("candidate_hash")
  
  // Statistics
  totalCandidates     Int        @map("total_candidates")
  totalComparisons    Int        @map("total_comparisons")
  totalInputTokens    Int        @default(0) @map("total_input_tokens")
  totalOutputTokens   Int        @default(0) @map("total_output_tokens")
  totalTokens         Int        @default(0) @map("total_tokens")
  inputCost           Float      @default(0) @map("input_cost")
  outputCost          Float      @default(0) @map("output_cost")
  totalCost           Float      @default(0) @map("total_cost")
  
  // Timestamps
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
  
  // Relation
  jobPosting          JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  @@index([jobPostingId])
  @@index([candidateHash])
  @@map("candidate_rankings")
}

enum UserType {
  CANDIDATE
  EMPLOYER
}

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum WorkType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
}

enum PayType {
  ANNUAL_SALARY
  HOURLY_RATE
  DAILY_RATE
  PROJECT_BASED
}

enum ExperienceLevel {
  INTERN
  JUNIOR
  MID_LEVEL
  SENIOR
  LEAD
  PRINCIPAL
}

enum ProductType {
  JUNIOR
  SENIOR
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}
